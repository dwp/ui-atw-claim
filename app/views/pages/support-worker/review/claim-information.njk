{% extends "casa/review/page-block.njk" %}

{% from "components/card-summary/macro.njk" import customSummaryCardTable with context %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}

{% block reviewBlock %}

    {% set claim = journeyContext['__hidden_support_page__'] %}
    {% set files = journeyContext['__hidden_uploaded_files__'].files %}
    {% set refererUrl = '?edit&editorigin=' + casa.mountUrl + 'check-your-answers' %}
    {% set data = [] %}
    {% set totalHoursOfSupport = 0 %}
    {% set totalMinutesOfSupport = 0 %}
    {% set totalCost = journeyContext['support-cost'].totalCost %}
    {% set nonAtwCost = journeyContext['__grant_being_claimed__'].nonAtwCost %}

    {% set monthLength = claim | length %}

        {% for monthIndex, month in claim %} 

            {% for day in month['claim'] %}
                
                {% set totalHoursOfSupport = totalHoursOfSupport + day['timeOfSupport']['hoursOfSupport'] %}
                {% set totalMinutesOfSupport = totalMinutesOfSupport + day['timeOfSupport']['minutesOfSupport'] %}

                {% set hoursOfSupportBlock %}
                    {{ (day['timeOfSupport']['hoursOfSupport'] + t('common:hour') if day['timeOfSupport']['hoursOfSupport'] | int === 1 else day['timeOfSupport']['hoursOfSupport'] + t('common:hours')) }}
                {% endset -%}

                {% set minutesOfSupportBlock %}
                    {{ (day['timeOfSupport']['minutesOfSupport'] + t('common:minute') if day['timeOfSupport']['minutesOfSupport'] | int === 1 else day['timeOfSupport']['minutesOfSupport'] + t('common:minutes')) }} 
                {% endset -%}

                {% set monthBlock %}
                    {{ hoursOfSupportBlock + t('common:and') + minutesOfSupportBlock }} 
                {% endset -%}

                {% set data = (data.push(
                        {
                            key: { text: day['dayOfSupport'] + ' ' + month['monthYear'] | formatMonthYearObject(t) },
                            value: { text: ((monthBlock | safe) + t('common:from') + (day['nameOfSupport']) if day['nameOfSupport'] else monthBlock | safe) },
                            actions: {
                            items: [
                                {
                                    href: 'support-days' + refererUrl + '&changeMonthYear=' + monthIndex ,
                                    text: t('review:block.changeLink'),
                                    visuallyHiddenText: t('claim-information:reviewBlock.changeDaysOfSupport', month['monthYear'] | formatMonth(t)),
                                    classes: 'govuk-link--no-visited-state hide-print'
                                }
                            ]
                            }
                        }
                ), data) %}

            {% endfor %}
        
            {{ customSummaryCardTable({
                card: {
                    title: { text: t('claim-information:reviewBlock.monthOfSupport', month['monthYear'] | formatMonthYearObject(t)) }
                },
                rows: data
            }) }}

            {% set data = [] %}
        {% endfor %}

        {% set filesBLock %}
            <ul class="govuk-list">
                {% for f in files %}
                    {% if f %}
                        <li>{{ f['fileName'] }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% endset -%}

        {% set convertedMinutes = (totalHoursOfSupport * 60) + totalMinutesOfSupport %}
        {% set convertedHours = (convertedMinutes/60) %}
        {% set roundedHours %} 
            {{ convertedHours | round(0, "floor") }} 
        {% endset -%}
        {% set minutes = (convertedHours - roundedHours)*60 %}
        {% set roundedMinutes %}
            {{ minutes | round }}
        {% endset -%}

    {{ customSummaryCardTable({
        card: {
            title: { text: t('claim-information:reviewBlock.totalHoursAndCosts') }
        },
        rows: [
            {
                key: { text: t('claim-information:reviewBlock.totalHoursOfSupport') },
                value: { text: (roundedHours + t('common:hour') if roundedHours | int === 1 else roundedHours + t('common:hours'))
                        + t('common:and') +
                        (roundedMinutes + t('common:minute') if roundedMinutes | int === 1 else roundedMinutes + t('common:minutes'))
                        + t('common:ofSupport') },
                actions: {
                items: [
                        {
                            href: 'support-claim-summary' + refererUrl,
                            text: t('review:block.changeLink'),
                            visuallyHiddenText: t('claim-information:reviewBlock.changeTotalHoursOfSupport'),
                            classes: 'govuk-link--no-visited-state hide-print'
                        }
                ]
                }
            },
            {
                key: { text: t('claim-information:reviewBlock.totalCost') },
                value: { text: 'Â£' + totalCost },
                actions: {
                items: [
                    {
                        href: 'support-cost' + refererUrl,
                        text: t('review:block.changeLink'),
                        visuallyHiddenText: t('claim-information:reviewBlock.changeTotalCost'),
                        classes: 'govuk-link--no-visited-state hide-print'
                    }
                ]
                }
            },
            {
                key: { text: t('claim-information:reviewBlock.files') },
                value: { text: (filesBLock | safe) },
                actions: {
                items: [
                    {
                        href: 'receipts-invoices-uploaded' + refererUrl,
                        text: t('review:block.changeLink'),
                        visuallyHiddenText: t('claim-information:reviewBlock.changeFiles'),
                        classes: 'govuk-link--no-visited-state hide-print'
                    }
                ]
                }
            }
        ]
    }) }}

{% endblock %}
